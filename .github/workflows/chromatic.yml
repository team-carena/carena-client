name: 'Chromatic'

on:
  # develop ë° main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰
  push:
    branches: [develop, main]

  # PRì´ ìƒì„±, ì—…ë°ì´íŠ¸, ì¬ì˜¤í”ˆë  ë•Œ ì‹¤í–‰
  pull_request:
    types: [opened, synchronize, reopened]

# GitHub í† í° ê¶Œí•œ ì„¤ì •
permissions:
  contents: read # ì½”ë“œ ì €ì¥ì†Œ ì½˜í…ì¸  ì½ê¸° ê¶Œí•œ
  pull-requests: write # PRì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œ

jobs:
  chromatic:
    # Ubuntu ìµœì‹  ë²„ì „ í™˜ê²½ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # ì „ì²´ Git íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜¤ê¸°
          fetch-depth: 0

      # 2. PNPM íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì„¤ì •
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      # 3. Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'pnpm'

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # 5. Storybook ë¹Œë“œ
      - name: Build Storybook
        run: pnpm build-storybook

      # 6. Chromatic ë°°í¬
      - name: Publish to Chromatic
        id: chromatic
        uses: chromaui/action@latest
        with:
          # Chromatic í”„ë¡œì íŠ¸ í† í°
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          # ì´ë¯¸ ë¹Œë“œëœ ìŠ¤í† ë¦¬ë¶ ë””ë ‰í† ë¦¬ ì§€ì • (ë¹Œë“œ ì‹œê°„ ì ˆì•½)
          storybookBuildDir: storybook-static
          # PRì—ì„œë§Œ ë³€ê²½ëœ ìŠ¤í† ë¦¬ë§Œ í…ŒìŠ¤íŠ¸
          onlyChanged: ${{ github.event_name == 'pull_request' }}
          # develop ë¸Œëœì¹˜ì—ì„œëŠ” ë³€ê²½ì‚¬í•­ ìë™ ìŠ¹ì¸
          autoAcceptChanges: ${{ github.ref == 'refs/heads/develop' }}
          # ì‹œê°ì  ë³€ê²½ì´ ìˆì–´ë„ CI ì‹¤íŒ¨ ë°©ì§€
          exitZeroOnChanges: true

      # 7. ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
      - name: Create Coverage Report
        id: coverage
        # always(): ì´ì „ ë‹¨ê³„ ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
        if: always()
        run: |
          # GITHUB_STEP_SUMMARY: GitHub Actions ìš”ì•½ í˜ì´ì§€ì— í‘œì‹œë  ë‚´ìš©
          echo "## ğŸ“Š Storybook Coverage Report" >> $GITHUB_STEP_SUMMARY
          # ìŠ¤í† ë¦¬ íŒŒì¼ ê°œìˆ˜ ê³„ì‚°
          echo "- **Total Components**: $(find src -name "*.stories.tsx" | wc -l)" >> $GITHUB_STEP_SUMMARY
          # Chromatic ë‹¨ê³„ì˜ ì‹¤í–‰ ê²°ê³¼ (success/failure)
          echo "- **Build Status**: ${{ steps.chromatic.outcome }}" >> $GITHUB_STEP_SUMMARY
          # ë°°í¬ëœ ìŠ¤í† ë¦¬ë¶ URL (ì—†ìœ¼ë©´ N/A í‘œì‹œ)
          echo "- **Storybook URL**: ${{ steps.chromatic.outputs.storybookUrl || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          # Chromatic ë¹Œë“œ URL
          echo "- **Chromatic Build**: ${{ steps.chromatic.outputs.buildUrl || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          # ë¹Œë“œ ì‹œê°„ ê¸°ë¡
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY

      # 8. PR ì½”ë©˜íŠ¸
      - name: Comment PR
        # PR ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          # comment_tag: ë™ì¼í•œ íƒœê·¸ì˜ ê¸°ì¡´ ì½”ë©˜íŠ¸ë¥¼ ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ë°©ì§€)
          comment_tag: chromatic-build
          # ì½”ë©˜íŠ¸ ë‚´ìš©
          message: |
            ## ğŸ¨ Storybook ë¹Œë“œ ì™„ë£Œ!

            ğŸ”– **Storybook**: ${{ steps.chromatic.outputs.storybookUrl }}
            ğŸ§ª **Chromatic**: ${{ steps.chromatic.outputs.buildUrl }}

            ### ğŸ“Š ë¹Œë“œ ì •ë³´
            - **ë¹Œë“œ ìƒíƒœ**: ${{ steps.chromatic.outcome }}
            - **í…ŒìŠ¤íŠ¸ëœ ìŠ¤í† ë¦¬**: ${{ steps.chromatic.outputs.actualTestCount || '0' }}ê°œ
            - **ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸**: ${{ steps.chromatic.outputs.actualCaptureCount || '0' }}ê°œ

            ${{ steps.chromatic.outputs.changeCount && format('> ğŸ” **ì‹œê°ì  ë³€ê²½ì‚¬í•­**: {0}ê°œ ë°œê²¬', steps.chromatic.outputs.changeCount) || '' }}